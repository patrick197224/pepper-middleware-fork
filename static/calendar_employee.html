<!-- calendar with fixed appointment dates displayed and visible appointment description for employee view-->
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Weekly Calendar</title>

<style>
    body { 
        font-family: Arial; 
        margin: 20px; 
    }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        table-layout: fixed; 
    }
    th, td { 
        border: 1px solid #ccc; 
        padding: 6px; 
    }
    th { 
        background: #4CAF50; 
        color: white; 
    }
    .appointment { 
        padding: 4px 6px;
        margin: 3px 0;
        background: #d9edf7;
        border-radius: 4px;
        border-left: 4px solid #31708f; 
        font-size: 14px;
    }
    #weekButtons {
        position: absolute;
        top:20px;
        right:20px;
    }
    #weekButtons button{
        padding: 6px 12px;
        margin-left: 8px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #aaa;
        background: #f2f2f2;
        cursor: pointer;
    }
</style>

</head>
<body>
    
<h2 id="title"></h2> 

<div id="weekButtons">
    <button id="prevWeek">← Previous week</button>
    <button id="nextWeek">Next week →</button>
</div>

<table id="calendarTable"></table>

<script type="module">

// -------------------------------
// Load appointments from database
// -------------------------------
let appointments = [];
async function loadAppointments(startDate, endDate) {
    const url = `/appointments?start=${startDate}&end=${endDate}`;
    const res = await fetch(url);
    appointments = await res.json() //date, time, patient, notes
}

// -------------------------------
// URL parameters
// -------------------------------
function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
}

// -------------------------------
// Date formatting (local time, not UTC)
// -------------------------------
function formatDateLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
}

// -------------------------------
// week calculation
// -------------------------------

// Convert year + week number → Monday date
function getMondayOfISOWeek(week, year) {
    const simple = new Date(year, 0, 1 + (week - 1) * 7);
    const dow = simple.getDay();
    const ISOweekStart = simple;
    if (dow <= 4)
        ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
    else
        ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
    return ISOweekStart;
}

function goToWeek(newWeek, newYear){
    window.location.href =  `?year=${newYear}&week=${newWeek}`; //updates the url fitting for selected week
}

// to get last week of the year with the thursday of the last week
function getISOWeeksInYear(year){
    const lastThursday = new Date(Date.UTC(year,11,28));
    return lastThursday.getWeekNumber();
}

// extension of the Date object to calculate the ISO calendar week (according to ISO the thursday of a week is relevant for which year it belongs to)
Date.prototype.getWeekNumber = function(){
    const date = new Date(Date.UTC(this.getFullYear(), this.getMonth(), this.getDate())); //copy of the date regarding timezone problems
    const dayNum = date.getUTCDay() || 7;                                                 // gets weekday, changes sunday from 0 to 7
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);                                      // changes date to the thursday of same week
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));                    // creates date for first day of the year the thursday belongs to
    return Math.ceil((((date - yearStart)/ 86400000) + 1) / 7);                           // rounds up for teh calculated week, +1 to prevent day 0 -> week 0
};

// -------------------------------
// get week and year from URL
// -------------------------------


let year = parseInt(getQueryParam("year")) || 2026; 
let week = parseInt(getQueryParam("week")) || 2; 
const monday = getMondayOfISOWeek(week, year);

// build list of 7 days in this week
const days = [];
for (let i = 0; i < 7; i++) {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    days.push(d);
}

// -------------------------------
// week switch buttons and page title
// -------------------------------
document.getElementById("prevWeek").onclick = () => {
    let newWeek = week - 1;
    let newYear = year;
    // got to last week of previous year
    if (newWeek < 1){
        newYear--;        
        newWeek = getISOWeeksInYear(newYear);
    }
    goToWeek(newWeek,newYear);
};

document.getElementById("nextWeek").onclick = () => {
    let newWeek = week + 1;
    let newYear = year;
    // find number of weeks in current year
    const weaksCurrentYear = getISOWeeksInYear(year);
    if (newWeek > weaksCurrentYear){      
        newWeek = 1;
        newYear++;  
    }
    goToWeek(newWeek,newYear);
};

document.getElementById("title").textContent =
    `Week ${week}, ${year} (${days[0].toDateString()} - ${days[6].toDateString()})`;


// -------------------------------
// load data for table
// -------------------------------
await loadAppointments(
    formatDateLocal(days[0]),
    formatDateLocal(days[6])
);

// -------------------------------
// render calendar table
// -------------------------------

const startHour = 8;
const endHour = 17;
const table = document.getElementById("calendarTable");

// header row
let headerRow = "<tr><th>Time</th>";
days.forEach(d => {
    const label = d.toLocaleDateString("en-GB", { weekday: "short", day: "numeric", month: "short" });
    const isoDate = formatDateLocal(d);
    headerRow += `<th data-date="${isoDate}">${label}</th>`;
});
headerRow += "</tr>";
table.innerHTML = headerRow;

// timeslots
for (let hour = startHour; hour < endHour; hour++) {
    let row = `<tr><th>${hour}:00</th>`;

    days.forEach(d => {
        const isoDate = formatDateLocal(d);
        const timeString = String(hour).padStart(2, "0") + ":00"; // pads hour times to two digits if necessary
        const cellApps = appointments.filter(a =>
            a.date === isoDate && a.time === timeString
        );

        let html = "";
        cellApps.forEach(a => {
            html += `<div class="appointment">
                ${a.patient}
                ${a.notes ? ("<small> — " + a.notes + "</small>") : ""}
                </div>`;
        });

        row += `<td>${html}</td>`;
    });

    row += "</tr>";
    table.innerHTML += row;
}

</script>

</body>
</html>